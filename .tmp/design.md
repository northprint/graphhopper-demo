# App Runner デプロイ失敗の調査と修正

## 問題の概要
GraphHopperがApp Runnerでデプロイ失敗している。ヘルスチェックが失敗している可能性がある。

## 調査結果

### 1. ヘルスチェックエンドポイントの問題
- App Runnerはポート8989の'/health'エンドポイントでヘルスチェックを実行している
- GraphHopperはDropwizardベースで、デフォルトではヘルスチェックは管理ポート（通常8081または11111）の'/healthcheck'で提供される
- 現在のconfig-demo.ymlには管理ポートの設定がない

### 2. メモリ設定の問題
- App RunnerでJAVA_OPTSが'-Xmx1g -Xms512m'に設定されている
- App Runnerのインスタンスは2GBメモリだが、JVMに1GB割り当てている
- GraphHopperは起動時にOSMデータを読み込むため、メモリ使用量が多い

### 3. 起動時間の問題
- S3からOSMデータをダウンロードしている
- GraphHopperの初期化に時間がかかる可能性がある
- ヘルスチェックのstart-periodが60秒に設定されているが、不十分かもしれない

## 解決策

### 1. ヘルスチェックエンドポイントの修正
以下のいずれかを実装：
- A. config-demo.ymlで管理コネクタを設定し、/healthcheckを有効化
- B. アプリケーションポート8989で/healthエンドポイントを提供するカスタムリソースを追加
- C. 単純にルートエンドポイント（/）をヘルスチェックに使用

### 2. メモリ設定の調整
- JAVA_OPTSを'-Xmx1500m -Xms512m'に変更（2GBインスタンスでOSのオーバーヘッドを考慮）

### 3. 起動時間の延長
- ヘルスチェックのstart-periodを120秒に延長
- タイムアウトを10秒に延長

## 推奨される対応
最も簡単で確実な方法として、以下を実施：
1. ヘルスチェックパスを'/'に変更（GraphHopperのルートは基本的なHTMLページを返す）
2. メモリ設定を調整
3. タイムアウト設定を延長
